#/bin/env sh

SCRIPTPATH=$(readlink -f "$0")
SCRIPTDIR=$(dirname "$SCRIPTPATH")
SHOULD_COMMIT=0

for arg in "$@"; do
    case "$arg" in
        -c)
            SHOULD_COMMIT=1
            ;;
    esac
done

if [ ! -f ".system" ]; then
    echo ".system file does not exist, please create one"
    exit 1
fi

PROFILE=$(cat .system)
PROFILEDIR="$SCRIPTDIR/systems/$PROFILE"

if [ ! -d "$PROFILEDIR" ]; then
    echo "system '$PROFILE' not found at '$PROFILEDIR'"
    exit 1
fi

echo "Building '${PROFILE}'"
cd "$PROFILEDIR" && nix flake update

if [ "$SHOULD_COMMIT" -eq 1 ]; then
    echo "comitting flake.lock"
    git commit flake.lock -m "${PROFILE}/meta: nix flake update"
fi
